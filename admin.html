<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—è³‡æ–™ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>å–®å­—è³‡æ–™ç®¡ç†ç³»çµ± V3.0</h1>
            <div class="version-info">
                ğŸš€ æ–°ç‰ˆæœ¬ç‰¹è‰²ï¼šæœ¬åœ°æª”æ¡ˆè™•ç†ã€è‡ªå‹•åˆ†ç´šã€åŒ…å«å¸¸ç”¨è©å¥ã€ç„¡éœ€API
            </div>
        </header>

        <main>
            <div class="file-upload-section">
                <h2>ğŸ“ æª”æ¡ˆä¸Šå‚³</h2>
                <div class="upload-area">
                    <label for="file-upload" class="upload-label">
                        <div class="upload-icon">ğŸ“„</div>
                        <div>é»æ“Šé¸æ“‡æˆ–æ‹–æ›³ TXT æª”æ¡ˆåˆ°æ­¤è™•</div>
                        <input type="file" id="file-upload" accept=".txt" style="display: none;">
                    </label>
                </div>
                <div id="file-status" class="status-message"></div>
            </div>

            <div class="processing-section">
                <h2>è™•ç†è¨­å®š</h2>
                <div class="process-info">
                    <h4>ğŸ“Š è‡ªå‹•åˆ†ç´šè¦å‰‡ï¼š</h4>
                    <ul>
                        <li><strong>300ä»¥ä¸‹ï¼š</strong> 1-200 (æœ€åŸºç¤å–®å­—)</li>
                        <li><strong>300-500ï¼š</strong> 201-700 (åŸºç¤å•†æ¥­å–®å­—)</li>
                        <li><strong>500-600ï¼š</strong> 701-1300 (ä¸­ç´šå•†æ¥­å–®å­—)</li>
                        <li><strong>600-700ï¼š</strong> 1301-2000 (é€²éšå•†æ¥­å–®å­—)</li>
                        <li><strong>700-800ï¼š</strong> 2001-2500 (å°ˆæ¥­å•†æ¥­å–®å­—)</li>
                        <li><strong>800-900ï¼š</strong> 2501-2800 (é«˜ç´šå°ˆæ¥­å–®å­—)</li>
                        <li><strong>900ä»¥ä¸Šï¼š</strong> 2801-3000 (æœ€é«˜ç´šå–®å­—)</li>
                    </ul>
                </div>
                
                <div class="button-group">
                    <button id="process-btn" class="primary-btn" disabled>é–‹å§‹è™•ç†æª”æ¡ˆ</button>
                    <button id="save-static-btn" class="secondary-btn" disabled>ç”¢ç”Ÿéœæ…‹è³‡æ–™æª”</button>
                </div>
            </div>

            <div class="progress-section">
                <h2>è™•ç†é€²åº¦</h2>
                <div id="process-log" class="log-area"></div>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <p id="progress-text">å¾…å‘½ä¸­...</p>
            </div>

            <div class="preview-section" style="display: none;">
                <h2>ğŸ“ è³‡æ–™é è¦½</h2>
                <div id="preview-stats" class="stats"></div>
                <div id="preview-sample" class="sample-area"></div>
            </div>

            <div class="database-section">
                <h2>è³‡æ–™åº«ç®¡ç†</h2>
                <div class="stats">
                    <div class="stat-item">
                        <span>ç¸½å–®å­—æ•¸ï¼š</span>
                        <span id="total-words">0</span>
                    </div>
                    <div class="stat-item" id="level-stats"></div>
                </div>
                
                <div class="action-buttons">
                    <button id="export-btn">åŒ¯å‡º JSON</button>
                    <button id="import-btn">åŒ¯å…¥ JSON</button>
                    <button id="clear-btn" class="danger-btn">æ¸…ç©ºè³‡æ–™åº«</button>
                </div>
                <input type="file" id="json-file-input" style="display: none;" accept=".json" />
            </div>
        </main>
    </div>

    <script src="js/database.js"></script>
    <script src="js/local-generator.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let uploadedContent = null;
            
            // åˆå§‹åŒ–è³‡æ–™åº«çµ±è¨ˆ
            updateStatistics();
            
            // æª”æ¡ˆä¸Šå‚³è™•ç†
            const fileUpload = document.getElementById('file-upload');
            const uploadArea = document.querySelector('.upload-area');
            const fileStatus = document.getElementById('file-status');
            const processBtn = document.getElementById('process-btn');
            const saveStaticBtn = document.getElementById('save-static-btn');
            
            // æ‹–æ”¾åŠŸèƒ½
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'text/plain') {
                    handleFile(files[0]);
                } else {
                    fileStatus.textContent = 'è«‹é¸æ“‡ TXT æª”æ¡ˆ';
                    fileStatus.className = 'status-message error';
                }
            });
            
            // æª”æ¡ˆé¸æ“‡
            fileUpload.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
            
            // è™•ç†æª”æ¡ˆ
            async function handleFile(file) {
                fileStatus.textContent = `å·²é¸æ“‡ï¼š${file.name}`;
                fileStatus.className = 'status-message success';
                
                uploadedContent = await file.text();
                processBtn.disabled = false;
                
                // é è¦½æª”æ¡ˆå‰å¹¾è¡Œ
                const lines = uploadedContent.split('\n').slice(0, 5);
                console.log('æª”æ¡ˆé è¦½ï¼š', lines);
            }
            
            // è™•ç†æŒ‰éˆ•
            processBtn.addEventListener('click', async () => {
                if (!uploadedContent) {
                    alert('è«‹å…ˆé¸æ“‡æª”æ¡ˆ');
                    return;
                }
                
                const logArea = document.getElementById('process-log');
                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');
                
                processBtn.disabled = true;
                logArea.innerHTML = 'ğŸš€ é–‹å§‹è™•ç†æª”æ¡ˆ...\n';
                
                try {
                    // è™•ç†æª”æ¡ˆ
                    const processedWords = await localGenerator.processFile(uploadedContent);
                    logArea.innerHTML += `âœ… æˆåŠŸè§£æ ${processedWords.length} å€‹å–®å­—\n`;
                    
                    // é¡¯ç¤ºçµ±è¨ˆ
                    const stats = localGenerator.getStatistics();
                    logArea.innerHTML += '\nğŸ“Š ç­‰ç´šåˆ†å¸ƒï¼š\n';
                    for (const [level, count] of Object.entries(stats.byLevel)) {
                        logArea.innerHTML += `  ${level}: ${count} å€‹å–®å­—\n`;
                    }
                    
                    // å„²å­˜åˆ°è³‡æ–™åº«
                    logArea.innerHTML += '\nğŸ’¾ å„²å­˜åˆ°è³‡æ–™åº«...\n';
                    await wordDB.init();
                    
                    const result = await localGenerator.saveToDatabase((message, progress) => {
                        if (message) {
                            logArea.innerHTML += message + '\n';
                            logArea.scrollTop = logArea.scrollHeight;
                        }
                        if (progress !== undefined) {
                            progressFill.style.width = `${progress}%`;
                            progressText.textContent = `é€²åº¦: ${Math.round(progress)}%`;
                        }
                    });
                    
                    logArea.innerHTML += `\nğŸ‰ è™•ç†å®Œæˆï¼å…±å„²å­˜ ${result.total} å€‹å–®å­—\n`;
                    
                    // é¡¯ç¤ºé è¦½
                    showPreview(processedWords);
                    
                    // å•Ÿç”¨éœæ…‹æª”æ¡ˆç”¢ç”ŸæŒ‰éˆ•
                    saveStaticBtn.disabled = false;
                    
                    // æ›´æ–°çµ±è¨ˆ
                    await updateStatistics();
                    
                } catch (error) {
                    logArea.innerHTML += `âŒ è™•ç†å¤±æ•—: ${error.message}\n`;
                    console.error(error);
                }
                
                processBtn.disabled = false;
            });
            
            // ç”¢ç”Ÿéœæ…‹è³‡æ–™æª”
            saveStaticBtn.addEventListener('click', () => {
                const staticData = localGenerator.generateStaticDataFile();
                const jsonData = JSON.stringify(staticData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'toeic_words_static.json';
                a.click();
                URL.revokeObjectURL(url);
                
                alert('éœæ…‹è³‡æ–™æª”å·²ç”¢ç”Ÿï¼è«‹å°‡æª”æ¡ˆæ”¾ç½®åœ¨ data/ è³‡æ–™å¤¾ä¸­ã€‚');
            });
            
            // é¡¯ç¤ºé è¦½
            function showPreview(words) {
                const previewSection = document.querySelector('.preview-section');
                const previewStats = document.getElementById('preview-stats');
                const previewSample = document.getElementById('preview-sample');
                
                previewSection.style.display = 'block';
                
                // é¡¯ç¤ºçµ±è¨ˆ
                const stats = localGenerator.getStatistics();
                previewStats.innerHTML = `
                    <div>ç¸½å–®å­—æ•¸: ${stats.total}</div>
                    <div>ç­‰ç´šåˆ†å¸ƒ: ${Object.entries(stats.byLevel).map(([l, c]) => `${l}(${c})`).join(', ')}</div>
                `;
                
                // é¡¯ç¤ºæ¨£æœ¬ï¼ˆå‰5å€‹å–®å­—ï¼‰
                const samples = words.slice(0, 5);
                previewSample.innerHTML = '<h4>å–®å­—æ¨£æœ¬ï¼š</h4>';
                samples.forEach(word => {
                    previewSample.innerHTML += `
                        <div class="word-sample">
                            <strong>${word.word}</strong> ${word.phonetic} (${word.part_of_speech})
                            <br>ä¸­æ–‡: ${word.chinese}
                            <br>ç­‰ç´š: ${word.level}
                            <br>ä¾‹å¥: ${word.toeic_example.sentence}
                            <br>å¸¸ç”¨è©å¥: ${word.common_phrases.map(p => p.phrase).join(', ')}
                        </div>
                    `;
                });
            }
            
            // æ›´æ–°çµ±è¨ˆ
            async function updateStatistics() {
                await wordDB.init();
                const stats = await wordDB.getStatistics();
                
                const totalElement = document.getElementById('total-words');
                if (totalElement) {
                    totalElement.textContent = stats.total;
                }
                
                const levelStatsElement = document.getElementById('level-stats');
                if (levelStatsElement) {
                    levelStatsElement.innerHTML = '';
                    
                    for (const [level, count] of Object.entries(stats.byLevel)) {
                        const statDiv = document.createElement('div');
                        statDiv.innerHTML = `<strong>${level}:</strong> ${count} å€‹`;
                        levelStatsElement.appendChild(statDiv);
                    }
                }
            }
            
            // åŒ¯å‡ºæŒ‰éˆ•
            document.getElementById('export-btn').addEventListener('click', async () => {
                const jsonData = await wordDB.exportToJSON();
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `toeic_words_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });
            
            // åŒ¯å…¥æŒ‰éˆ•
            const importBtn = document.getElementById('import-btn');
            const jsonFileInput = document.getElementById('json-file-input');
            
            importBtn.addEventListener('click', () => {
                jsonFileInput.click();
            });
            
            jsonFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const text = await file.text();
                    const result = await wordDB.importFromJSON(text);
                    
                    if (result.success) {
                        alert(`åŒ¯å…¥æˆåŠŸï¼\næ–°å¢: ${result.added.length}\né‡è¤‡: ${result.duplicates.length}`);
                        await updateStatistics();
                    } else {
                        alert(`åŒ¯å…¥å¤±æ•—: ${result.error}`);
                    }
                }
            });
            
            // æ¸…ç©ºæŒ‰éˆ•
            document.getElementById('clear-btn').addEventListener('click', async () => {
                if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                    await wordDB.clearDatabase();
                    await updateStatistics();
                    alert('è³‡æ–™åº«å·²æ¸…ç©º');
                }
            });
        });
    </script>

    <style>
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }
        
        .upload-area:hover {
            border-color: #007bff;
            background-color: #f0f8ff;
        }
        
        .upload-area.drag-over {
            border-color: #28a745;
            background-color: #e8f5e9;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .upload-label {
            display: block;
            cursor: pointer;
        }
        
        .process-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .process-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .preview-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .word-sample {
            background: white;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
        
        .sample-area {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</body>
</html>