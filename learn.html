<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>å¤šç›Šå–®å­—å­¸ç¿’ç³»çµ± - èªéŸ³ç‰ˆ</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .speech-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .speech-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .speak-word-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .speak-word-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .speak-sentence-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .speak-sentence-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
        }
        
        .speak-phrase-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .stop-btn {
            background: #e74c3c;
            color: white;
        }
        
        .stop-btn:hover {
            background: #c0392b;
        }
        
        .speech-settings {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .speed-slider {
            flex: 1;
        }
        
        .auto-play-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .voice-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2ecc71;
            margin-left: 5px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .speaking {
            animation: speaking 2s infinite ease-in-out;
        }
        
        @keyframes speaking {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.01); }
        }
        
        .phrase-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }
        
        .pronunciation-guide {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        
        .mode-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .mode-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #f0f0f0;
            transition: all 0.3s;
        }
        
        .mode-btn:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }
        
        .mode-btn.active {
            background: #007bff;
            color: white;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stats p {
            margin: 0;
        }
        
        /* ç­‰ç´šèª¿æ•´ç›¸é—œæ¨£å¼ */
        .word-level-container {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        
        .word-level-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* ç­‰ç´šé¡è‰² */
        .level-300ä»¥ä¸‹ { background: #e8f5e9; color: #2e7d32; }
        .level-300-500 { background: #fff3e0; color: #ef6c00; }
        .level-500-600 { background: #fce4ec; color: #c2185b; }
        .level-600-700 { background: #e8eaf6; color: #5e35b1; }
        .level-700-800 { background: #e1f5fe; color: #0277bd; }
        .level-800-900 { background: #fce4ec; color: #ad1457; }
        .level-900ä»¥ä¸Š { background: #f3e5f5; color: #6a1b9a; }
        
        .user-adjusted::after {
            content: " ğŸ”§";
            font-size: 12px;
        }
        
        .adjust-level-btn, .quick-adjust-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            background: white;
            transition: all 0.3s;
        }
        
        .adjust-level-btn:hover, .quick-adjust-btn:hover {
            background: #f0f0f0;
            transform: scale(1.1);
        }
        
        /* ç­‰ç´šèª¿æ•´å°è©±æ¡† */
        .level-adjust-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .level-adjust-dialog {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .level-adjust-dialog h3 {
            margin: 0 0 20px 0;
            color: #333;
        }
        
        .adjust-form-group {
            margin: 15px 0;
        }
        
        .adjust-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .adjust-form-group select,
        .adjust-form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .adjust-form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .level-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .adjust-dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .adjust-dialog-buttons button {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-confirm {
            background: #4caf50;
            color: white;
        }
        
        .btn-cancel {
            background: #f44336;
            color: white;
        }
        
        .btn-reset {
            background: #ff9800;
            color: white;
        }
        
        .adjust-dialog-buttons button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å¤šç›Šå–®å­—å­¸ç¿’ç³»çµ± 
                <span id="voice-status" class="voice-indicator" style="display: none;"></span>
            </h1>
            <div class="level-selector">
                <label for="level">é¸æ“‡ç¨‹åº¦ï¼š</label>
                <select id="level">
                    <option value="300ä»¥ä¸‹">300åˆ†ä»¥ä¸‹</option>
                    <option value="300-500" selected>300-500åˆ†</option>
                    <option value="500-600">500-600åˆ†</option>
                    <option value="600-700">600-700åˆ†</option>
                    <option value="700-800">700-800åˆ†</option>
                    <option value="800-900">800-900åˆ†</option>
                    <option value="900ä»¥ä¸Š">900åˆ†ä»¥ä¸Š</option>
                </select>
                <button id="load-level-btn" class="load-btn">è¼‰å…¥</button>
            </div>
        </header>

        <main>
            <!-- èªéŸ³è¨­å®šå€ -->
            <div class="speech-settings">
                <h3>ğŸ”Š èªéŸ³è¨­å®š</h3>
                <div class="speed-control">
                    <label>æœ—è®€é€Ÿåº¦ï¼š</label>
                    <input type="range" id="speed-slider" class="speed-slider" 
                           min="0.5" max="1.5" step="0.1" value="0.9">
                    <span id="speed-value">0.9x</span>
                </div>
                <div class="auto-play-toggle">
                    <input type="checkbox" id="auto-play">
                    <label for="auto-play">è‡ªå‹•æœ—è®€æ–°å–®å­—</label>
                </div>
                <div class="animation-toggle" style="margin-top: 10px;">
                    <input type="checkbox" id="enable-animation" checked>
                    <label for="enable-animation">å•Ÿç”¨æœ—è®€å‹•ç•«æ•ˆæœ</label>
                </div>
                <div class="voice-selector" style="margin-top: 10px;">
                    <label>èªéŸ³é¸æ“‡ï¼š</label>
                    <select id="voice-select" style="max-width: 300px;">
                        <option value="">ç³»çµ±é è¨­</option>
                    </select>
                </div>
            </div>

            <div id="word-card" class="word-card">
                <div class="word-header">
                    <h2 id="word">Loading...</h2>
                    <div class="speech-controls">
                        <button id="speak-word-btn" class="speech-btn speak-word-btn">
                            ğŸ”Š å¿µå–®å­—
                        </button>
                        <button id="speak-all-btn" class="speech-btn speak-sentence-btn">
                            ğŸ“¢ å®Œæ•´æœ—è®€
                        </button>
                        <button id="stop-btn" class="speech-btn stop-btn" style="display: none;">
                            â¹ åœæ­¢
                        </button>
                    </div>
                </div>
                
                <div id="learning-hint" class="learning-hint">
                    ğŸ’¡ å…ˆæƒ³æƒ³é€™å€‹å–®å­—çš„æ„æ€ï¼Œç„¶å¾Œé»ã€Œé¡¯ç¤ºç­”æ¡ˆã€æŸ¥çœ‹è©³è§£
                </div>
                
                <div class="pronunciation-guide" id="pronunciation-guide" style="display: none;">
                    ğŸ¯ ç™¼éŸ³æç¤ºï¼šä»”ç´°è†è½æ¯éŸ³å’Œé‡éŸ³ä½ç½®
                </div>
                
                <div class="word-level-container" style="margin: 10px 0;">
                    <span id="word-level" class="word-level-badge"></span>
                    <button id="adjust-level-btn" class="adjust-level-btn" title="èª¿æ•´ç­‰ç´š">âœï¸</button>
                    <button id="quick-up-btn" class="quick-adjust-btn" title="æå‡ä¸€ç´š">â¬†ï¸</button>
                    <button id="quick-down-btn" class="quick-adjust-btn" title="é™ä½ä¸€ç´š">â¬‡ï¸</button>
                </div>
                
                <p id="phonetic" class="phonetic"></p>
                <p id="part-of-speech" class="part-of-speech"></p>
                <p id="chinese" class="chinese"></p>
                
                <div class="phrases" id="phrases-section" style="display: none;">
                    <h3>å¸¸ç”¨è©å¥</h3>
                    <div id="phrases-list"></div>
                </div>
                
                <div class="example">
                    <h3>å¤šç›Šä¾‹å¥
                        <button id="speak-sentence-btn" class="speech-btn speak-phrase-btn">
                            ğŸ”Š å¿µä¾‹å¥
                        </button>
                    </h3>
                    <p id="example-sentence"></p>
                    <p id="example-chinese" class="chinese"></p>
                </div>
            </div>

            <div class="controls">
                <button id="prev-btn">ä¸Šä¸€å€‹</button>
                <button id="show-answer-btn">é¡¯ç¤ºç­”æ¡ˆ</button>
                <button id="next-btn">ä¸‹ä¸€å€‹</button>
                <button id="mark-btn">æ¨™è¨˜</button>
                <button id="review-btn">è¤‡ç¿’ (<span id="marked-count">0</span>)</button>
            </div>

            <div class="mode-controls">
                <button id="toggle-mode-btn" class="mode-btn">ğŸ² éš¨æ©Ÿæ¨¡å¼</button>
                <button id="reshuffle-btn" class="mode-btn">ğŸ”„ é‡æ–°æ´—ç‰Œ</button>
            </div>

            <div class="stats">
                <p>ä»Šæ—¥å­¸ç¿’ï¼š<span id="today-count">0</span> å€‹</p>
                <p>ç¸½é€²åº¦ï¼š<span id="progress">0/0</span></p>
                <p>ç­‰ç´šé€²åº¦ï¼š<span id="level-progress">0%</span></p>
                <p>å·²å­¸ç¿’ï¼š<span id="learned-count">0</span></p>
            </div>
        </main>
    </div>

    <!-- ç­‰ç´šèª¿æ•´å°è©±æ¡† -->
    <div id="level-adjust-modal" class="level-adjust-modal">
        <div class="level-adjust-dialog">
            <h3>èª¿æ•´å–®å­—ç­‰ç´š</h3>
            
            <div class="level-info">
                <div>å–®å­—ï¼š<strong id="adjust-word-text"></strong></div>
                <div>åŸå§‹ç­‰ç´šï¼š<span id="adjust-original-level"></span></div>
                <div>ç•¶å‰ç­‰ç´šï¼š<span id="adjust-current-level"></span></div>
            </div>
            
            <div class="adjust-form-group">
                <label for="adjust-new-level">èª¿æ•´ç‚ºï¼š</label>
                <select id="adjust-new-level">
                    <option value="300ä»¥ä¸‹">300ä»¥ä¸‹ - æœ€åŸºç¤å–®å­—</option>
                    <option value="300-500">300-500 - åŸºç¤å•†æ¥­å–®å­—</option>
                    <option value="500-600">500-600 - ä¸­ç´šå•†æ¥­å–®å­—</option>
                    <option value="600-700">600-700 - é€²éšå•†æ¥­å–®å­—</option>
                    <option value="700-800">700-800 - å°ˆæ¥­å•†æ¥­å–®å­—</option>
                    <option value="800-900">800-900 - é«˜ç´šå°ˆæ¥­å–®å­—</option>
                    <option value="900ä»¥ä¸Š">900ä»¥ä¸Š - æœ€é«˜ç´šå–®å­—</option>
                </select>
            </div>
            
            <div class="adjust-form-group">
                <label for="adjust-reason">èª¿æ•´åŸå› ï¼ˆé¸å¡«ï¼‰ï¼š</label>
                <textarea id="adjust-reason" placeholder="ä¾‹å¦‚ï¼šé€™å€‹å­—æ¯”é æœŸå›°é›£..."></textarea>
            </div>
            
            <div class="adjust-dialog-buttons">
                <button id="adjust-reset-btn" class="btn-reset">æ¢å¾©åŸå§‹</button>
                <button id="adjust-cancel-btn" class="btn-cancel">å–æ¶ˆ</button>
                <button id="adjust-confirm-btn" class="btn-confirm">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <script src="js/database.js"></script>
    <script src="js/speech.js"></script>
    <script src="js/app.js"></script>
    <script>
        // èªéŸ³åŠŸèƒ½åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // æª¢æŸ¥èªéŸ³æ”¯æ´
            if (!speechService.isSupported) {
                document.querySelector('.speech-settings').innerHTML = 
                    '<p style="color: red;">âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½</p>';
                return;
            }
            
            // è¼‰å…¥å¯ç”¨èªéŸ³
            setTimeout(() => {
                const voices = speechService.getAvailableVoices();
                const voiceSelect = document.getElementById('voice-select');
                
                voices.forEach(voice => {
                    if (voice.lang.startsWith('en')) {
                        const option = document.createElement('option');
                        option.value = voice.name;
                        option.textContent = `${voice.name} (${voice.lang})`;
                        voiceSelect.appendChild(option);
                    }
                });
            }, 1000);
            
            // èªéŸ³é¸æ“‡è®Šæ›´
            document.getElementById('voice-select').addEventListener('change', (e) => {
                if (e.target.value) {
                    speechService.setVoice(e.target.value);
                }
            });
            
            // é€Ÿåº¦æ§åˆ¶
            const speedSlider = document.getElementById('speed-slider');
            const speedValue = document.getElementById('speed-value');
            
            speedSlider.addEventListener('input', (e) => {
                const speed = parseFloat(e.target.value);
                speedValue.textContent = `${speed}x`;
                speechService.updateSettings({ rate: speed });
            });
            
            // å¿µå–®å­—æŒ‰éˆ•
            document.getElementById('speak-word-btn').addEventListener('click', async () => {
                const word = document.getElementById('word').textContent;
                if (word && word !== 'Loading...') {
                    showSpeakingStatus(true);
                    // ä½¿ç”¨ç•¶å‰é€Ÿåº¦è¨­å®š
                    const currentRate = parseFloat(document.getElementById('speed-slider').value);
                    await speechService.speak(word, { rate: currentRate * 0.8 }); // å–®å­—ç¨æ…¢
                    showSpeakingStatus(false);
                }
            });
            
            // å®Œæ•´æœ—è®€æŒ‰éˆ•
            document.getElementById('speak-all-btn').addEventListener('click', async () => {
                const wordData = getCurrentWordData();
                if (wordData) {
                    showSpeakingStatus(true);
                    const currentRate = parseFloat(document.getElementById('speed-slider').value);
                    // å…ˆå¿µå–®å­—ï¼ˆæ…¢é€Ÿï¼‰
                    await speechService.speak(wordData.word, { rate: currentRate * 0.7 });
                    await new Promise(resolve => setTimeout(resolve, 500));
                    // å†å¿µä¸€æ¬¡ï¼ˆæ­£å¸¸é€Ÿï¼‰
                    await speechService.speak(wordData.word, { rate: currentRate });
                    await new Promise(resolve => setTimeout(resolve, 800));
                    // å¿µä¾‹å¥
                    if (wordData.toeic_example?.sentence) {
                        await speechService.speak(wordData.toeic_example.sentence, { rate: currentRate });
                    }
                    showSpeakingStatus(false);
                }
            });
            
            // å¿µä¾‹å¥æŒ‰éˆ•
            document.getElementById('speak-sentence-btn').addEventListener('click', async () => {
                const sentence = document.getElementById('example-sentence').textContent;
                if (sentence) {
                    showSpeakingStatus(true);
                    const currentRate = parseFloat(document.getElementById('speed-slider').value);
                    await speechService.speak(sentence, { rate: currentRate });
                    showSpeakingStatus(false);
                }
            });
            
            // åœæ­¢æŒ‰éˆ•
            document.getElementById('stop-btn').addEventListener('click', () => {
                speechService.stop();
                showSpeakingStatus(false);
            });
            
            // è‡ªå‹•æœ—è®€
            const autoPlay = document.getElementById('auto-play');
            
            // ç›£è½å–®å­—è®Šæ›´äº‹ä»¶ï¼ˆéœ€è¦åœ¨ app.js ä¸­è§¸ç™¼ï¼‰
            document.addEventListener('wordChanged', (event) => {
                if (autoPlay.checked && event.detail) {
                    setTimeout(() => {
                        const currentRate = parseFloat(document.getElementById('speed-slider').value);
                        speechService.speak(event.detail.word, { rate: currentRate * 0.8 });
                    }, 500);
                }
            });
            
            // é¡¯ç¤ºæœ—è®€ç‹€æ…‹
            function showSpeakingStatus(speaking) {
                const indicator = document.getElementById('voice-status');
                const stopBtn = document.getElementById('stop-btn');
                const enableAnimation = document.getElementById('enable-animation').checked;
                
                if (speaking) {
                    indicator.style.display = 'inline-block';
                    stopBtn.style.display = 'inline-flex';
                    // åªæœ‰åœ¨å•Ÿç”¨å‹•ç•«æ™‚æ‰æ·»åŠ  speaking class
                    if (enableAnimation) {
                        document.getElementById('word-card').classList.add('speaking');
                    }
                } else {
                    indicator.style.display = 'none';
                    stopBtn.style.display = 'none';
                    document.getElementById('word-card').classList.remove('speaking');
                }
            }
            
            // ç²å–ç•¶å‰å–®å­—è³‡æ–™
            function getCurrentWordData() {
                // é€™å€‹å‡½æ•¸éœ€è¦å¾ app.js ç²å–è³‡æ–™
                // æˆ–è€…ç›´æ¥å¾é é¢å…ƒç´ æ§‹å»º
                return {
                    word: document.getElementById('word').textContent,
                    chinese: document.getElementById('chinese').textContent,
                    toeic_example: {
                        sentence: document.getElementById('example-sentence').textContent,
                        chinese: document.getElementById('example-chinese').textContent
                    }
                };
            }
            
            // ç‚ºå¸¸ç”¨è©å¥æ·»åŠ æœ—è®€æŒ‰éˆ•
            document.addEventListener('phrasesLoaded', (event) => {
                const phrasesList = document.getElementById('common-phrases-list');
                if (phrasesList && event.detail) {
                    phrasesList.innerHTML = '';
                    event.detail.forEach((phrase, index) => {
                        const phraseDiv = document.createElement('div');
                        phraseDiv.className = 'phrase-item';
                        phraseDiv.innerHTML = `
                            <span>${phrase.phrase} - ${phrase.chinese}</span>
                            <button class="speech-btn speak-phrase-btn" 
                                    onclick="speechService.speak('${phrase.phrase}', {rate: 0.85})">
                                ğŸ”Š
                            </button>
                        `;
                        phrasesList.appendChild(phraseDiv);
                    });
                }
            });
        });
        
        // ç­‰ç´šèª¿æ•´åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            const levels = ['300ä»¥ä¸‹', '300-500', '500-600', '600-700', '700-800', '800-900', '900ä»¥ä¸Š'];
            let currentWordData = null;
            
            // èª¿æ•´ç­‰ç´šæŒ‰éˆ•
            document.getElementById('adjust-level-btn').addEventListener('click', () => {
                showLevelAdjustDialog();
            });
            
            // å¿«é€Ÿä¸Šå‡æŒ‰éˆ•
            document.getElementById('quick-up-btn').addEventListener('click', () => {
                quickAdjustLevel('up');
            });
            
            // å¿«é€Ÿä¸‹é™æŒ‰éˆ•
            document.getElementById('quick-down-btn').addEventListener('click', () => {
                quickAdjustLevel('down');
            });
            
            // é¡¯ç¤ºç­‰ç´šèª¿æ•´å°è©±æ¡†
            function showLevelAdjustDialog() {
                const word = document.getElementById('word').textContent;
                if (!word || word === 'Loading...') return;
                
                // å¾è³‡æ–™åº«ç²å–å®Œæ•´å–®å­—è³‡æ–™
                wordDB.findWordByText(word).then(wordData => {
                    if (!wordData) return;
                    
                    currentWordData = wordData;
                    
                    // å¡«å……å°è©±æ¡†è³‡è¨Š
                    document.getElementById('adjust-word-text').textContent = wordData.word;
                    document.getElementById('adjust-original-level').textContent = wordData.original_level || wordData.level;
                    document.getElementById('adjust-current-level').textContent = wordData.level;
                    document.getElementById('adjust-new-level').value = wordData.level;
                    document.getElementById('adjust-reason').value = '';
                    
                    // é¡¯ç¤ºå°è©±æ¡†
                    const modal = document.getElementById('level-adjust-modal');
                    modal.style.display = 'flex';
                });
            }
            
            // å¿«é€Ÿèª¿æ•´ç­‰ç´š
            function quickAdjustLevel(direction) {
                const word = document.getElementById('word').textContent;
                if (!word || word === 'Loading...') return;
                
                wordDB.findWordByText(word).then(wordData => {
                    if (!wordData) return;
                    
                    const currentIndex = levels.indexOf(wordData.level);
                    let newIndex;
                    
                    if (direction === 'up' && currentIndex < levels.length - 1) {
                        newIndex = currentIndex + 1;
                    } else if (direction === 'down' && currentIndex > 0) {
                        newIndex = currentIndex - 1;
                    } else {
                        return; // å·²ç¶“æ˜¯æœ€é«˜æˆ–æœ€ä½ç­‰ç´š
                    }
                    
                    const newLevel = levels[newIndex];
                    const reason = direction === 'up' ? 'å¿«é€Ÿæå‡ç­‰ç´š' : 'å¿«é€Ÿé™ä½ç­‰ç´š';
                    
                    // æ›´æ–°è³‡æ–™åº«
                    wordDB.updateWordLevel(wordData.id, newLevel, reason).then(updatedWord => {
                        // æ›´æ–°é¡¯ç¤º
                        updateLevelDisplay(updatedWord);
                        
                        // é¡¯ç¤ºæç¤º
                        showLevelChangeNotification(wordData.level, newLevel);
                    });
                });
            }
            
            // ç¢ºèªèª¿æ•´
            document.getElementById('adjust-confirm-btn').addEventListener('click', () => {
                if (!currentWordData) return;
                
                const newLevel = document.getElementById('adjust-new-level').value;
                const reason = document.getElementById('adjust-reason').value;
                
                if (newLevel === currentWordData.level) {
                    closeLevelAdjustDialog();
                    return;
                }
                
                // æ›´æ–°è³‡æ–™åº«
                wordDB.updateWordLevel(currentWordData.id, newLevel, reason).then(updatedWord => {
                    // æ›´æ–°é¡¯ç¤º
                    updateLevelDisplay(updatedWord);
                    
                    // é¡¯ç¤ºæç¤º
                    showLevelChangeNotification(currentWordData.level, newLevel);
                    
                    // é—œé–‰å°è©±æ¡†
                    closeLevelAdjustDialog();
                });
            });
            
            // æ¢å¾©åŸå§‹ç­‰ç´š
            document.getElementById('adjust-reset-btn').addEventListener('click', () => {
                if (!currentWordData) return;
                
                wordDB.resetWordLevel(currentWordData.id).then(updatedWord => {
                    // æ›´æ–°é¡¯ç¤º
                    updateLevelDisplay(updatedWord);
                    
                    // é¡¯ç¤ºæç¤º
                    showLevelChangeNotification(currentWordData.level, updatedWord.level);
                    
                    // é—œé–‰å°è©±æ¡†
                    closeLevelAdjustDialog();
                });
            });
            
            // å–æ¶ˆèª¿æ•´
            document.getElementById('adjust-cancel-btn').addEventListener('click', () => {
                closeLevelAdjustDialog();
            });
            
            // é—œé–‰å°è©±æ¡†
            function closeLevelAdjustDialog() {
                const modal = document.getElementById('level-adjust-modal');
                modal.style.display = 'none';
                currentWordData = null;
            }
            
            // æ›´æ–°ç­‰ç´šé¡¯ç¤º
            function updateLevelDisplay(wordData) {
                const levelBadge = document.getElementById('word-level');
                if (levelBadge) {
                    levelBadge.textContent = wordData.level;
                    levelBadge.className = `word-level-badge level-${wordData.level.replace('/', '-')}`;
                    
                    if (wordData.user_adjusted) {
                        levelBadge.classList.add('user-adjusted');
                    }
                }
                
                // æ›´æ–°è¨˜æ†¶é«”ä¸­çš„è³‡æ–™
                if (window.app && window.app.currentWords) {
                    const index = window.app.currentWords.findIndex(w => w.id === wordData.id);
                    if (index !== -1) {
                        window.app.currentWords[index] = wordData;
                    }
                }
            }
            
            // é¡¯ç¤ºç­‰ç´šè®Šæ›´é€šçŸ¥
            function showLevelChangeNotification(fromLevel, toLevel) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4caf50;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    z-index: 2000;
                    animation: slideIn 0.3s;
                `;
                notification.textContent = `ç­‰ç´šå·²èª¿æ•´ï¼š${fromLevel} â†’ ${toLevel}`;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }
            
            // é»æ“Šå¤–éƒ¨é—œé–‰å°è©±æ¡†
            document.getElementById('level-adjust-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeLevelAdjustDialog();
                }
            });
        });
        
        // å‹•ç•«æ¨£å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>