<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæˆå™¨ V2.0 æ¸¬è©¦</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { 
            padding: 10px 15px; 
            margin: 5px; 
            cursor: pointer;
        }
        #log {
            background: #f5f5f5;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ ç”Ÿæˆå™¨ V2.0 æ¸¬è©¦é é¢</h1>
    
    <div class="test-section">
        <h2>åŸºæœ¬åŠŸèƒ½æ¸¬è©¦</h2>
        <button onclick="testBasicFunctions()">æ¸¬è©¦åŸºæœ¬åŠŸèƒ½</button>
        <button onclick="testPromptGeneration()">æ¸¬è©¦ Prompt ç”Ÿæˆ</button>
        <button onclick="testDuplicateCheck()">æ¸¬è©¦é‡è¤‡æª¢æŸ¥</button>
        <button onclick="testCostMonitor()">æ¸¬è©¦æˆæœ¬ç›£æ§</button>
    </div>

    <div class="test-section">
        <h2>JSON è§£ææ¸¬è©¦</h2>
        <button onclick="testJSONParsing()">æ¸¬è©¦ JSON è§£æ</button>
        <button onclick="testBackupWords()">æ¸¬è©¦å¾Œå‚™è©åº«</button>
    </div>

    <div class="test-section">
        <h2>æ¯”è¼ƒæ¸¬è©¦</h2>
        <p>æ¯”è¼ƒæ–°èˆŠç”Ÿæˆå™¨çš„å·®ç•°</p>
        <button onclick="compareGenerators()">æ¯”è¼ƒç”Ÿæˆå™¨</button>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦æ—¥èªŒ</h2>
        <div id="log"></div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <script src="js/database.js"></script>
    <script src="js/generator.js"></script>
    <script src="js/generator-v2.js"></script>
    
    <script>
        const log = document.getElementById('log');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            log.innerHTML += `[${timestamp}] <span class="${className}">${message}</span>\n`;
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            log.innerHTML = '';
        }

        // æ¸¬è©¦åŸºæœ¬åŠŸèƒ½
        function testBasicFunctions() {
            addLog('=== åŸºæœ¬åŠŸèƒ½æ¸¬è©¦ ===');
            
            try {
                const generatorV2 = new WordGeneratorV2();
                addLog('âœ… WordGeneratorV2 å¯¦ä¾‹åŒ–æˆåŠŸ', 'success');
                
                // æ¸¬è©¦é…ç½®
                addLog(`ğŸ“‹ æ‰¹æ¬¡å¤§å°: ${generatorV2.config.batchSize}`);
                addLog(`ğŸ“‹ æ¨¡å‹: ${generatorV2.config.model}`);
                addLog(`ğŸ“‹ æº«åº¦: ${generatorV2.config.temperature}`);
                addLog(`ğŸ“‹ é¿å…åˆ—è¡¨é™åˆ¶: ${generatorV2.config.avoidListLimit}`);
                
                // æ¸¬è©¦æˆæœ¬ç›£æ§åˆå§‹åŒ–
                const report = generatorV2.getCostReport();
                addLog(`ğŸ’° åˆå§‹æˆæœ¬: $${report.totalCost}`, 'success');
                
            } catch (error) {
                addLog(`âŒ åŸºæœ¬åŠŸèƒ½æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸¬è©¦ Prompt ç”Ÿæˆ
        function testPromptGeneration() {
            addLog('=== Prompt ç”Ÿæˆæ¸¬è©¦ ===');
            
            try {
                const generatorV2 = new WordGeneratorV2();
                
                // æ¨¡æ“¬ç¾æœ‰å–®å­—
                generatorV2.existingWords.add('business');
                generatorV2.existingWords.add('meeting');
                generatorV2.recentWords = ['client', 'report', 'schedule'];
                
                const avoidWords = generatorV2.getMustAvoidWords('300-500');
                addLog(`ğŸš« é¿å…å–®å­—åˆ—è¡¨ (${avoidWords.length}): ${avoidWords.join(', ')}`);
                
                const prompt = generatorV2.buildMinimalPrompt('300-500', 5, avoidWords);
                addLog(`ğŸ“ ç”Ÿæˆçš„ Prompt é•·åº¦: ${prompt.length} å­—å…ƒ`);
                addLog(`ğŸ“ Prompt é è¦½:\n${prompt.substring(0, 200)}...`, 'info');
                
            } catch (error) {
                addLog(`âŒ Prompt ç”Ÿæˆæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸¬è©¦é‡è¤‡æª¢æŸ¥
        function testDuplicateCheck() {
            addLog('=== é‡è¤‡æª¢æŸ¥æ¸¬è©¦ ===');
            
            try {
                const generatorV2 = new WordGeneratorV2();
                
                // æ¨¡æ“¬å–®å­—æ•¸æ“š
                const testWords = [
                    { word: 'budget', chinese: 'é ç®—' },
                    { word: 'Budget', chinese: 'é ç®—' }, // å¤§å¯«é‡è¤‡
                    { word: 'client', chinese: 'å®¢æˆ¶' },
                    { word: 'report', chinese: 'å ±å‘Š' },
                    { word: 'budget', chinese: 'é ç®—' }  // å®Œå…¨é‡è¤‡
                ];
                
                const filtered = generatorV2.filterValidWords(testWords, '300-500');
                addLog(`ğŸ“Š åŸå§‹å–®å­—æ•¸: ${testWords.length}`);
                addLog(`ğŸ“Š éæ¿¾å¾Œå–®å­—æ•¸: ${filtered.length}`);
                addLog(`âœ… é€šéçš„å–®å­—: ${filtered.map(w => w.word).join(', ')}`, 'success');
                
                // æ¸¬è©¦ç›¸ä¼¼åº¦æª¢æŸ¥
                generatorV2.existingWords.add('work');
                const isSimilar = generatorV2.isTooSimilar('works');
                addLog(`ğŸ” 'works' èˆ‡ 'work' ç›¸ä¼¼åº¦æª¢æŸ¥: ${isSimilar ? 'å¤ªç›¸ä¼¼' : 'å¯æ¥å—'}`, 
                      isSimilar ? 'success' : 'error');
                
            } catch (error) {
                addLog(`âŒ é‡è¤‡æª¢æŸ¥æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸¬è©¦æˆæœ¬ç›£æ§
        function testCostMonitor() {
            addLog('=== æˆæœ¬ç›£æ§æ¸¬è©¦ ===');
            
            try {
                const generatorV2 = new WordGeneratorV2();
                
                // æ¨¡æ“¬ API èª¿ç”¨æˆæœ¬
                const mockUsage = {
                    prompt_tokens: 100,
                    completion_tokens: 50,
                    total_tokens: 150
                };
                
                generatorV2.trackCost(mockUsage);
                
                const report = generatorV2.getCostReport();
                addLog(`ğŸ’° æ¨¡æ“¬èª¿ç”¨å¾Œæˆæœ¬å ±å‘Š:`);
                addLog(`   - èª¿ç”¨æ¬¡æ•¸: ${report.totalCalls}`);
                addLog(`   - ç¸½ Token: ${report.totalTokens}`);
                addLog(`   - ç¸½æˆæœ¬: $${report.totalCost.toFixed(6)}`);
                addLog(`   - å¹³å‡æˆæœ¬: $${report.averageCostPerCall.toFixed(6)}`);
                addLog(`   - å‰©é¤˜é ç®—: $${report.remainingBudget.toFixed(2)}`, 'success');
                
                // æ¸¬è©¦é‡ç½®
                generatorV2.resetCostMonitor();
                const resetReport = generatorV2.getCostReport();
                addLog(`ğŸ”„ é‡ç½®å¾Œç¸½æˆæœ¬: $${resetReport.totalCost}`, 'success');
                
            } catch (error) {
                addLog(`âŒ æˆæœ¬ç›£æ§æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸¬è©¦ JSON è§£æ
        function testJSONParsing() {
            addLog('=== JSON è§£ææ¸¬è©¦ ===');
            
            try {
                const generatorV2 = new WordGeneratorV2();
                
                // æ¸¬è©¦æ­£å¸¸ JSON
                const validJSON = `{
                    "words": [
                        {
                            "word": "test",
                            "chinese": "æ¸¬è©¦",
                            "phonetic": "/test/",
                            "part_of_speech": "noun",
                            "toeic_example": {"sentence": "This is a test.", "chinese": "é€™æ˜¯æ¸¬è©¦ã€‚"}
                        }
                    ]
                }`;
                
                const result1 = generatorV2.parseResponse(validJSON);
                addLog(`âœ… æ­£å¸¸ JSON è§£æ: ${result1.words.length} å€‹å–®å­—`, 'success');
                
                // æ¸¬è©¦å¸¶åƒåœ¾çš„ JSON
                const messyJSON = `é€™æ˜¯ä¸€äº›èªªæ˜æ–‡å­—
                
                ${validJSON}
                
                é‚„æœ‰ä¸€äº›çµå°¾æ–‡å­—`;
                
                const result2 = generatorV2.parseResponse(messyJSON);
                addLog(`âœ… å¸¶åƒåœ¾ JSON è§£æ: ${result2.words.length} å€‹å–®å­—`, 'success');
                
                // æ¸¬è©¦å®Œå…¨éŒ¯èª¤çš„å›æ‡‰
                const badResponse = "é€™ä¸æ˜¯JSONï¼Œåªæ˜¯æ™®é€šæ–‡å­—å›æ‡‰";
                const result3 = generatorV2.parseResponse(badResponse);
                addLog(`âš ï¸ éŒ¯èª¤å›æ‡‰è™•ç†: ${result3.words.length} å€‹å–®å­— (æ‡‰è©²æ˜¯0)`, 
                      result3.words.length === 0 ? 'success' : 'error');
                
            } catch (error) {
                addLog(`âŒ JSON è§£ææ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸¬è©¦å¾Œå‚™è©åº«
        function testBackupWords() {
            addLog('=== å¾Œå‚™è©åº«æ¸¬è©¦ ===');
            
            try {
                const generatorV2 = new WordGeneratorV2();
                
                const backupWords = generatorV2.getBackupWords('300-500', 3);
                addLog(`ğŸ”„ å¾Œå‚™è©åº«ç²å–: ${backupWords.length} å€‹å–®å­—`);
                addLog(`ğŸ”„ å–®å­—åˆ—è¡¨: ${backupWords.map(w => `${w.word}(${w.chinese})`).join(', ')}`, 'success');
                
                // æ¸¬è©¦ä¸å­˜åœ¨çš„ç­‰ç´š
                const backupWords2 = generatorV2.getBackupWords('ä¸å­˜åœ¨ç­‰ç´š', 2);
                addLog(`ğŸ”„ ä¸å­˜åœ¨ç­‰ç´šè™•ç†: ${backupWords2.length} å€‹å–®å­— (ä½¿ç”¨é è¨­)`, 'success');
                
            } catch (error) {
                addLog(`âŒ å¾Œå‚™è©åº«æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¯”è¼ƒç”Ÿæˆå™¨
        function compareGenerators() {
            addLog('=== ç”Ÿæˆå™¨æ¯”è¼ƒ ===');
            
            try {
                const oldGenerator = new WordGenerator();
                const newGenerator = new WordGeneratorV2();
                
                addLog('ğŸ“Š åŠŸèƒ½æ¯”è¼ƒ:');
                addLog(`   èˆŠç‰ˆæ¨¡å‹: GPT-4`);
                addLog(`   æ–°ç‰ˆæ¨¡å‹: ${newGenerator.config.model}`);
                addLog(`   èˆŠç‰ˆæº«åº¦: 0.9`);
                addLog(`   æ–°ç‰ˆæº«åº¦: ${newGenerator.config.temperature}`);
                addLog(`   æ–°ç‰ˆæ‰¹æ¬¡å¤§å°: ${newGenerator.config.batchSize}`);
                addLog(`   æ–°ç‰ˆé‡è©¦æ¬¡æ•¸: ${newGenerator.config.maxRetries}`);
                
                addLog('ğŸ†• V2.0 æ–°åŠŸèƒ½:');
                addLog(`   âœ… æˆæœ¬ç›£æ§å’Œé è­¦`);
                addLog(`   âœ… ç°¡åŒ–çš„ JSON è™•ç†`);
                addLog(`   âœ… å¤šå±¤é˜²é‡è¤‡æ©Ÿåˆ¶`);
                addLog(`   âœ… æ™ºèƒ½é¿å…åˆ—è¡¨ç®¡ç†`);
                addLog(`   âœ… å¾Œå‚™è©åº«æ©Ÿåˆ¶`, 'success');
                
            } catch (error) {
                addLog(`âŒ ç”Ÿæˆå™¨æ¯”è¼ƒå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦
        document.addEventListener('DOMContentLoaded', () => {
            addLog('ğŸš€ ç”Ÿæˆå™¨ V2.0 æ¸¬è©¦é é¢å·²è¼‰å…¥', 'success');
            addLog('é»æ“Šä¸Šæ–¹æŒ‰éˆ•åŸ·è¡Œå„é …æ¸¬è©¦');
        });
    </script>
</body>
</html>